<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SplitMojo.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">CSS Splitter Maven Plugin</a> &gt; <a href="index.source.html" class="el_package">biz.gabrys.maven.plugins.css.splitter</a> &gt; <span class="el_source">SplitMojo.java</span></div><h1>SplitMojo.java</h1><pre class="source lang-java linenums">/*
 * CSS Splitter Maven Plugin
 * http://css-splitter-maven-plugin.projects.gabrys.biz/
 *
 * Copyright (c) 2015 Adam Gabry≈õ
 *
 * This file is licensed under the BSD 3-Clause (the &quot;License&quot;).
 * You may not use this file except in compliance with the License.
 * You may obtain:
 * - a copy of the License at project page
 * - a template of the License at https://opensource.org/licenses/BSD-3-Clause
 */
package biz.gabrys.maven.plugins.css.splitter;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.List;

import org.apache.commons.io.FileUtils;
import org.apache.maven.plugin.AbstractMojo;
import org.apache.maven.plugin.MojoExecutionException;
import org.apache.maven.plugin.MojoFailureException;
import org.apache.maven.plugins.annotations.LifecyclePhase;
import org.apache.maven.plugins.annotations.Mojo;
import org.apache.maven.plugins.annotations.Parameter;

import biz.gabrys.maven.plugin.util.io.DestinationFileCreator;
import biz.gabrys.maven.plugin.util.io.FileScanner;
import biz.gabrys.maven.plugin.util.io.ScannerFactory;
import biz.gabrys.maven.plugin.util.io.ScannerPatternFormat;
import biz.gabrys.maven.plugin.util.timer.SystemTimer;
import biz.gabrys.maven.plugin.util.timer.Timer;
import biz.gabrys.maven.plugins.css.splitter.counter.LoggingStyleSheetCounter;
import biz.gabrys.maven.plugins.css.splitter.counter.StyleSheetCounter;
import biz.gabrys.maven.plugins.css.splitter.counter.StyleSheetCounterImpl;
import biz.gabrys.maven.plugins.css.splitter.css.Standard;
import biz.gabrys.maven.plugins.css.splitter.css.types.StyleSheet;
import biz.gabrys.maven.plugins.css.splitter.net.UrlEscaper;
import biz.gabrys.maven.plugins.css.splitter.split.Splliter;
import biz.gabrys.maven.plugins.css.splitter.steadystate.SteadyStateParser;
import biz.gabrys.maven.plugins.css.splitter.token.TokenType;
import biz.gabrys.maven.plugins.css.splitter.validation.RulesLimitValidator;
import biz.gabrys.maven.plugins.css.splitter.validation.StylePropertiesLimitValidator;
import biz.gabrys.maven.plugins.css.splitter.validation.StyleSheetValidator;
import biz.gabrys.maven.plugins.css.splitter.validation.ValidationException;

/**
 * Splits &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; stylesheets to smaller files (parts).
 * @since 1.0
 */
@Mojo(name = &quot;split&quot;, defaultPhase = LifecyclePhase.PROCESS_SOURCES, threadSafe = true)
<span class="nc" id="L55">public class SplitMojo extends AbstractMojo {</span>

    private static final String PART_INDEX_PARAMETER = &quot;{index}&quot;;

    /**
     * Defines whether to skip the plugin execution.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.skip&quot;, defaultValue = &quot;false&quot;)
    protected boolean skip;

    /**
     * Defines whether the plugin runs in verbose mode.&lt;br&gt;
     * &lt;b&gt;Notice&lt;/b&gt;: always true in debug mode.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.verbose&quot;, defaultValue = &quot;false&quot;)
    protected boolean verbose;

    /**
     * Forces to always split the &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; stylesheets. By default sources are
     * only split when modified or the main destination files does not exist.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.force&quot;, defaultValue = &quot;false&quot;)
    protected boolean force;

    /**
     * The directory which contains the &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; stylesheets.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.sourceDirectory&quot;, defaultValue = &quot;${project.basedir}/src/main/css&quot;)
    protected File sourceDirectory;

    /**
     * The directory for split &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; stylesheets.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.outputDirectory&quot;, defaultValue = &quot;${project.build.directory}&quot;)
    protected File outputDirectory;

    /**
     * Defines inclusion and exclusion fileset patterns format. Available options:
     * &lt;ul&gt;
     * &lt;li&gt;&lt;b&gt;ant&lt;/b&gt; - &lt;a href=&quot;http://ant.apache.org/&quot;&gt;Ant&lt;/a&gt;
     * &lt;a href=&quot;http://ant.apache.org/manual/dirtasks.html#patterns&quot;&gt;patterns&lt;/a&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;regex&lt;/b&gt; - regular expressions (use '/' as path separator)&lt;/li&gt;
     * &lt;/ul&gt;
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.filesetPatternFormat&quot;, defaultValue = &quot;ant&quot;)
    protected String filesetPatternFormat;

    /**
     * List of files to include. Specified as fileset patterns which are relative to the
     * &lt;a href=&quot;#sourceDirectory&quot;&gt;source directory&lt;/a&gt;. See &lt;a href=&quot;#filesetPatternFormat&quot;&gt;available fileset patterns
     * formats&lt;/a&gt;.&lt;br&gt;
     * &lt;b&gt;Default value is&lt;/b&gt;: &lt;tt&gt;[&quot;&amp;#42;&amp;#42;/&amp;#42;.css&quot;]&lt;/tt&gt; for &lt;a href=&quot;#filesetPatternFormat&quot;&gt;ant&lt;/a&gt; or
     * &lt;tt&gt;[&quot;^.+\.css$&quot;]&lt;/tt&gt; for &lt;a href=&quot;#filesetPatternFormat&quot;&gt;regex&lt;/a&gt;.
     * @since 1.0
     */
<span class="nc" id="L116">    @Parameter</span>
    protected String[] includes = new String[0];

    /**
     * List of files to exclude. Specified as fileset patterns which are relative to the
     * &lt;a href=&quot;#sourceDirectory&quot;&gt;source directory&lt;/a&gt;. See &lt;a href=&quot;#filesetPatternFormat&quot;&gt;available fileset patterns
     * formats&lt;/a&gt;.&lt;br&gt;
     * &lt;b&gt;Default value is&lt;/b&gt;: &lt;tt&gt;[]&lt;/tt&gt;.
     * @since 1.0
     */
<span class="nc" id="L126">    @Parameter</span>
    protected String[] excludes = new String[0];

    /**
     * The maximum number of &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; &amp;quot;style rules&amp;quot; in destination
     * files. &amp;quot;Style rule&amp;quot; is a rule that contains properties. Examples:
     * 
     * &lt;pre&gt;
     * /&amp;#42; count as 2 &amp;#42;/
     * &amp;#64;font-face {
     *      font-family: FontFamilyName;
     *      src: url(&amp;quot;font.woff2&amp;quot;) format(&amp;quot;woff2&amp;quot;), url(&amp;quot;font.ttf&amp;quot;) format(&amp;quot;truetype&amp;quot;);
     * }
     * /&amp;#42; count as 4 &amp;#42;/
     * .element {
     *      width: 100px;
     *      height: 200px;
     *      margin: 0;
     *      padding: 0;
     * }
     * /&amp;#42; count as 1 (for safety) &amp;#42;/
     * .empty {
     * }
     * /&amp;#42; count as 0 &amp;#42;/
     * &amp;#64;media screen and (min-width: 480px) {
     * }
     * /&amp;#42; summary: count as 2 &amp;#42;/
     * &amp;#64;media screen and (min-width: 480px) {
     *     /&amp;#42; count as 1 &amp;#42;/
     *     rule {
     *          width: 100px;
     *     }
     *     /&amp;#42; count as 1 (for safety) &amp;#42;/
     *     .empty {
     *     }
     * }
     * &lt;/pre&gt;
     * 
     * &lt;b&gt;Notice&lt;/b&gt;: all values smaller than &lt;tt&gt;1&lt;/tt&gt; are treated as &lt;tt&gt;2147483647&lt;/tt&gt;.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.maxRules&quot;, defaultValue = &quot;4095&quot;)
    protected int maxRules;

    /**
     * The plugin failures build when a number of &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; &amp;quot;style rules&amp;quot;
     * in source files exceeds this value. &amp;quot;Style rule&amp;quot; is a rule that contains properties. Examples:
     * 
     * &lt;pre&gt;
     * /&amp;#42; count as 2 &amp;#42;/
     * &amp;#64;font-face {
     *      font-family: FontFamilyName;
     *      src: url(&amp;quot;font.woff2&amp;quot;) format(&amp;quot;woff2&amp;quot;), url(&amp;quot;font.ttf&amp;quot;) format(&amp;quot;truetype&amp;quot;);
     * }
     * /&amp;#42; count as 4 &amp;#42;/
     * .element {
     *      width: 100px;
     *      height: 200px;
     *      margin: 0;
     *      padding: 0;
     * }
     * /&amp;#42; count as 1 (for safety) &amp;#42;/
     * .empty {
     * }
     * /&amp;#42; count as 0 &amp;#42;/
     * &amp;#64;media screen and (min-width: 480px) {
     * }
     * /&amp;#42; summary: count as 2 &amp;#42;/
     * &amp;#64;media screen and (min-width: 480px) {
     *     /&amp;#42; count as 1 &amp;#42;/
     *     rule {
     *          width: 100px;
     *     }
     *     /&amp;#42; count as 1 (for safety) &amp;#42;/
     *     .empty {
     *     }
     * }
     * &lt;/pre&gt;
     * 
     * &lt;b&gt;Notice&lt;/b&gt;: all values smaller than &lt;tt&gt;1&lt;/tt&gt; are treated as &lt;tt&gt;2147483647&lt;/tt&gt;.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.rulesLimit&quot;, defaultValue = &quot;2147483647&quot;)
    protected int rulesLimit;

    /**
     * The &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; standard used to parse source code. Available values:
     * &lt;ul&gt;
     * &lt;li&gt;&lt;b&gt;3.0&lt;/b&gt; - &lt;a href=&quot;https://www.w3.org/Style/CSS/&quot;&gt;Cascading Style Sheets Level 3&lt;/a&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;2.1&lt;/b&gt; - &lt;a href=&quot;https://www.w3.org/TR/CSS2/&quot;&gt;Cascading Style Sheets Level 2 Revision 1 (CSS 2.1)
     * Specification&lt;/a&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;2.0&lt;/b&gt; - &lt;a href=&quot;https://www.w3.org/TR/2008/REC-CSS2-20080411/&quot;&gt;Cascading Style Sheets Level 2&lt;/a&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;1.0&lt;/b&gt; - &lt;a href=&quot;https://www.w3.org/TR/CSS1/&quot;&gt;Cascading Style Sheets, level 1&lt;/a&gt;&lt;/li&gt;
     * &lt;/ul&gt;
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.standard&quot;, defaultValue = &quot;3.0&quot;)
    protected String standard;

    /**
     * Defines cache token type which will be added to &lt;code&gt;&amp;#64;import&lt;/code&gt; urls in destination
     * &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; stylesheets. Available options:
     * &lt;ul&gt;
     * &lt;li&gt;&lt;b&gt;custom&lt;/b&gt; - text specified by the user&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;date&lt;/b&gt; - build date&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;none&lt;/b&gt; - token will not be added&lt;/li&gt;
     * &lt;/ul&gt;
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.cacheTokenType&quot;, defaultValue = &quot;none&quot;)
    protected String cacheTokenType;

    /**
     * Defines cache token parameter name which will be added to &lt;code&gt;&amp;#64;import&lt;/code&gt; urls in destination
     * &lt;a href=&quot;http://www.w3.org/Style/CSS/&quot;&gt;CSS&lt;/a&gt; stylesheets.&lt;br&gt;
     * &lt;b&gt;Notice&lt;/b&gt;: ignored when &lt;a href=&quot;#cacheTokenType&quot;&gt;cache token type&lt;/a&gt; is equal to &lt;tt&gt;none&lt;/tt&gt;.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.cacheTokenParameter&quot;, defaultValue = &quot;v&quot;)
    protected String cacheTokenParameter;

    /**
     * Stores different values depending on the &lt;a href=&quot;#cacheTokenType&quot;&gt;cache token type&lt;/a&gt;:
     * &lt;ul&gt;
     * &lt;li&gt;&lt;b&gt;custom&lt;/b&gt; - user specified value (e.g. &lt;code&gt;constantText&lt;/code&gt;, &lt;code&gt;${variable}&lt;/code&gt;)&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;date&lt;/b&gt; - pattern for {@link java.text.SimpleDateFormat} object&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;none&lt;/b&gt; - ignored&lt;/li&gt;
     * &lt;/ul&gt;
     * &lt;b&gt;Default value is&lt;/b&gt;: &lt;tt&gt;yyyyMMddHHmmss&lt;/tt&gt; if &lt;a href=&quot;#cacheTokenType&quot;&gt;cache token type&lt;/a&gt; is equal to
     * &lt;tt&gt;date&lt;/tt&gt;.&lt;br&gt;
     * &lt;b&gt;Required&lt;/b&gt;: &lt;tt&gt;YES&lt;/tt&gt; if &lt;a href=&quot;#cacheTokenType&quot;&gt;cache token type&lt;/a&gt; is equal to &lt;tt&gt;custom&lt;/tt&gt;.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.cacheTokenValue&quot;)
    protected String cacheTokenValue;

    /**
     * Sources encoding.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.encoding&quot;, defaultValue = &quot;${project.build.sourceEncoding}&quot;)
    protected String encoding;

    /**
     * Destination files naming pattern. {fileName} is equal to source file name without extension.
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.outputFileNamePattern&quot;, defaultValue = DestinationFileCreator.FILE_NAME_PARAMETER + &quot;.css&quot;)
    protected String outputFileNamePattern;

    /**
     * Destination parts naming pattern. {fileName} is equal to source file name without extension, {index} is equal to
     * part index (first index is equal to 1).
     * @since 1.0
     */
    @Parameter(property = &quot;css.splitter.outputPartNamePattern&quot;, defaultValue = DestinationFileCreator.FILE_NAME_PARAMETER + '-'
            + PART_INDEX_PARAMETER + &quot;.css&quot;)
    protected String outputPartNamePattern;

    private void logParameters() {
<span class="nc bnc" id="L286" title="All 2 branches missed.">        if (getLog().isDebugEnabled()) {</span>
<span class="nc" id="L287">            getLog().debug(&quot;Job parameters:&quot;);</span>
<span class="nc" id="L288">            getLog().debug(&quot;\tskip = &quot; + skip);</span>
<span class="nc" id="L289">            getLog().debug(&quot;\tverbose = &quot; + verbose + createCalculatedInfo(Boolean.TRUE));</span>
<span class="nc" id="L290">            getLog().debug(&quot;\tforce = &quot; + force);</span>
<span class="nc" id="L291">            getLog().debug(&quot;\tsourceDirectory = &quot; + sourceDirectory);</span>
<span class="nc" id="L292">            getLog().debug(&quot;\toutputDirectory = &quot; + outputDirectory);</span>
<span class="nc" id="L293">            getLog().debug(&quot;\tfilesetPatternFormat = &quot; + filesetPatternFormat);</span>
<span class="nc bnc" id="L294" title="All 2 branches missed.">            String calculated = includes.length != 0 ? &quot;&quot; : createCalculatedInfo(Arrays.toString(getDefaultIncludes()));</span>
<span class="nc" id="L295">            getLog().debug(&quot;\tincludes = &quot; + Arrays.toString(includes) + calculated);</span>
<span class="nc" id="L296">            getLog().debug(&quot;\texcludes = &quot; + Arrays.toString(excludes));</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">            calculated = maxRules &gt; 0 ? &quot;&quot; : createCalculatedInfo(Integer.MAX_VALUE);</span>
<span class="nc" id="L298">            getLog().debug(&quot;\tmaxRules = &quot; + maxRules + calculated);</span>
<span class="nc bnc" id="L299" title="All 2 branches missed.">            calculated = rulesLimit &gt; 0 ? &quot;&quot; : createCalculatedInfo(Integer.MAX_VALUE);</span>
<span class="nc" id="L300">            getLog().debug(&quot;\trulesLimit = &quot; + rulesLimit + calculated);</span>
<span class="nc" id="L301">            getLog().debug(&quot;\tstandard = &quot; + standard);</span>
<span class="nc" id="L302">            getLog().debug(&quot;\tcacheTokenType = &quot; + cacheTokenType);</span>
<span class="nc" id="L303">            getLog().debug(&quot;\tcacheTokenParameter = &quot; + cacheTokenParameter);</span>
<span class="nc" id="L304">            calculated = &quot;&quot;;</span>
<span class="nc bnc" id="L305" title="All 2 branches missed.">            if (cacheTokenValue == null) {</span>
<span class="nc" id="L306">                final String defaultCacheTokenValue = getDefaultCacheTokenValue();</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">                calculated = defaultCacheTokenValue != null ? createCalculatedInfo(defaultCacheTokenValue) : &quot;&quot;;</span>
            }
<span class="nc" id="L309">            getLog().debug(&quot;\tcacheTokenValue = &quot; + cacheTokenValue + calculated);</span>
<span class="nc" id="L310">            getLog().debug(&quot;\tencoding = &quot; + encoding);</span>
<span class="nc" id="L311">            getLog().debug(&quot;\toutputFileNamePattern = &quot; + outputFileNamePattern);</span>
<span class="nc" id="L312">            getLog().debug(&quot;\toutputPartNamePattern = &quot; + outputPartNamePattern);</span>
<span class="nc" id="L313">            getLog().debug(&quot;&quot;);</span>
        }
<span class="nc" id="L315">    }</span>

    private static String createCalculatedInfo(final Object value) {
<span class="nc" id="L318">        return String.format(&quot; (calculated: %s)&quot;, value);</span>
    }

    private String[] getDefaultIncludes() {
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (ScannerPatternFormat.ANT.name().equalsIgnoreCase(filesetPatternFormat)) {</span>
<span class="nc" id="L323">            return new String[] { &quot;**/*.css&quot; };</span>
        } else {
<span class="nc" id="L325">            return new String[] { &quot;^.+\\.css$&quot; };</span>
        }
    }

    private String getDefaultCacheTokenValue() {
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (TokenType.DATE.name().equalsIgnoreCase(cacheTokenType)) {</span>
<span class="nc" id="L331">            return &quot;yyyyMMddHHmmss&quot;;</span>
        } else {
<span class="nc" id="L333">            return null;</span>
        }
    }

    private void calculateParameters() {
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (getLog().isDebugEnabled()) {</span>
<span class="nc" id="L339">            verbose = true;</span>
        }
<span class="nc bnc" id="L341" title="All 2 branches missed.">        if (includes.length == 0) {</span>
<span class="nc" id="L342">            includes = getDefaultIncludes();</span>
        }
<span class="nc bnc" id="L344" title="All 2 branches missed.">        if (maxRules &lt; 1) {</span>
<span class="nc" id="L345">            maxRules = Integer.MAX_VALUE;</span>
        }
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (rulesLimit &lt; 1) {</span>
<span class="nc" id="L348">            rulesLimit = Integer.MAX_VALUE;</span>
        }
<span class="nc bnc" id="L350" title="All 2 branches missed.">        if (cacheTokenValue == null) {</span>
<span class="nc" id="L351">            cacheTokenValue = getDefaultCacheTokenValue();</span>
        }
<span class="nc" id="L353">    }</span>

    private void validateParameters() throws MojoExecutionException {
<span class="nc bnc" id="L356" title="All 4 branches missed.">        if (cacheTokenValue == null &amp;&amp; TokenType.CUSTOM.name().equalsIgnoreCase(cacheTokenType)) {</span>
<span class="nc" id="L357">            throw new MojoExecutionException(&quot;Parameter cacheTokenValue is required when cacheTokenType is equal to \&quot;custom\&quot;!&quot;);</span>
        }
<span class="nc" id="L359">    }</span>

    public void execute() throws MojoExecutionException, MojoFailureException {
<span class="nc" id="L362">        logParameters();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (skip) {</span>
<span class="nc" id="L364">            getLog().info(&quot;Skipping job execution&quot;);</span>
<span class="nc" id="L365">            return;</span>
        }
<span class="nc" id="L367">        calculateParameters();</span>
<span class="nc" id="L368">        validateParameters();</span>
<span class="nc" id="L369">        runSplitter();</span>
<span class="nc" id="L370">    }</span>

    private void runSplitter() throws MojoFailureException {
<span class="nc bnc" id="L373" title="All 2 branches missed.">        if (!sourceDirectory.exists()) {</span>
<span class="nc" id="L374">            getLog().warn(&quot;Source directory does not exist: &quot; + sourceDirectory.getAbsolutePath());</span>
<span class="nc" id="L375">            return;</span>
        }
<span class="nc" id="L377">        final Collection&lt;File&gt; files = getFiles();</span>
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (files.isEmpty()) {</span>
<span class="nc" id="L379">            getLog().warn(&quot;No sources to compile&quot;);</span>
<span class="nc" id="L380">            return;</span>
        }
<span class="nc" id="L382">        splitFiles(files);</span>
<span class="nc" id="L383">    }</span>

    private Collection&lt;File&gt; getFiles() {
<span class="nc" id="L386">        final ScannerPatternFormat patternFormat = ScannerPatternFormat.toPattern(filesetPatternFormat);</span>
<span class="nc" id="L387">        final FileScanner scanner = new ScannerFactory().create(patternFormat, getLog());</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L389">            getLog().info(&quot;Scanning directory for sources...&quot;);</span>
        }
<span class="nc" id="L391">        return scanner.getFiles(sourceDirectory, includes, excludes);</span>
    }

    private void splitFiles(final Collection&lt;File&gt; sources) throws MojoFailureException {
<span class="nc bnc" id="L395" title="All 2 branches missed.">        final String sourceFilesText = &quot;source file&quot; + (sources.size() != 1 ? &quot;s&quot; : &quot;&quot;);</span>
<span class="nc" id="L396">        getLog().info(&quot;Splitting &quot; + sources.size() + ' ' + sourceFilesText + &quot; to &quot; + outputDirectory.getAbsolutePath());</span>
<span class="nc" id="L397">        final Timer timer = SystemTimer.getStartedTimer();</span>
<span class="nc bnc" id="L398" title="All 2 branches missed.">        for (final File source : sources) {</span>
<span class="nc bnc" id="L399" title="All 2 branches missed.">            if (isCompilationRequired(source)) {</span>
<span class="nc" id="L400">                splitFile(source);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">            } else if (verbose) {</span>
<span class="nc" id="L402">                getLog().info(&quot;Skipping stylesheet split (not modified): &quot; + source.getAbsolutePath());</span>
            }
<span class="nc" id="L404">        }</span>
<span class="nc" id="L405">        getLog().info(&quot;Finished &quot; + sourceFilesText + &quot; split in &quot; + timer.stop());</span>
<span class="nc" id="L406">    }</span>

    private boolean isCompilationRequired(final File source) {
<span class="nc bnc" id="L409" title="All 2 branches missed.">        if (force) {</span>
<span class="nc" id="L410">            return true;</span>
        }
<span class="nc" id="L412">        final File destination = new DestinationFileCreator(sourceDirectory, outputDirectory, outputFileNamePattern).create(source);</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">        if (!destination.exists()) {</span>
<span class="nc" id="L414">            return true;</span>
        }
<span class="nc bnc" id="L416" title="All 2 branches missed.">        return source.lastModified() &gt; destination.lastModified();</span>
    }

    private void splitFile(final File source) throws MojoFailureException {
<span class="nc" id="L420">        Timer timer = null;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L422">            getLog().info(&quot;Splitting stylesheet: &quot; + source.getAbsolutePath());</span>
<span class="nc" id="L423">            timer = SystemTimer.getStartedTimer();</span>
        }
<span class="nc" id="L425">        final String css = readCss(source);</span>
        final List&lt;StyleSheet&gt; parts;
        try {
<span class="nc bnc" id="L428" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L429">                getLog().info(&quot;Parsing stylesheet...&quot;);</span>
            }
<span class="nc" id="L431">            final StyleSheet stylesheet = new SteadyStateParser(getLog()).parse(css, Standard.create(standard));</span>
<span class="nc" id="L432">            validateStyleSheet(stylesheet);</span>
<span class="nc bnc" id="L433" title="All 2 branches missed.">            if (verbose) {</span>
<span class="nc" id="L434">                getLog().info(&quot;Splitting stylesheet to parts...&quot;);</span>
            }
<span class="nc" id="L436">            parts = new Splliter(maxRules).split(stylesheet);</span>
<span class="nc" id="L437">        } catch (final Exception e) {</span>
<span class="nc" id="L438">            throw new MojoFailureException(e.getMessage(), e);</span>
<span class="nc" id="L439">        }</span>
<span class="nc" id="L440">        saveParts(source, parts);</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">        if (timer != null) {</span>
<span class="nc" id="L442">            getLog().info(&quot;Finished in &quot; + timer.stop());</span>
        }
<span class="nc" id="L444">    }</span>

    private String readCss(final File file) throws MojoFailureException {
        try {
<span class="nc" id="L448">            return FileUtils.readFileToString(file, encoding);</span>
<span class="nc" id="L449">        } catch (final IOException e) {</span>
<span class="nc" id="L450">            throw new MojoFailureException(&quot;Cannot read file: &quot; + file.getAbsolutePath(), e);</span>
        }
    }

    private void validateStyleSheet(final StyleSheet stylesheet) throws ValidationException {
<span class="nc bnc" id="L455" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L456">            getLog().info(&quot;Validating stylesheet...&quot;);</span>
        }

<span class="nc" id="L459">        final Collection&lt;StyleSheetValidator&gt; validators = new ArrayList&lt;StyleSheetValidator&gt;();</span>
<span class="nc" id="L460">        StyleSheetCounter counter = new StyleSheetCounterImpl();</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L462">            counter = new LoggingStyleSheetCounter(counter, getLog());</span>
        }
<span class="nc" id="L464">        validators.add(new RulesLimitValidator(rulesLimit, counter));</span>
<span class="nc" id="L465">        validators.add(new StylePropertiesLimitValidator(maxRules, getLog()));</span>

<span class="nc bnc" id="L467" title="All 2 branches missed.">        for (final StyleSheetValidator validator : validators) {</span>
<span class="nc" id="L468">            validator.validate(stylesheet);</span>
<span class="nc" id="L469">        }</span>
<span class="nc" id="L470">    }</span>

    private void saveParts(final File source, final List&lt;StyleSheet&gt; parts) throws MojoFailureException {
<span class="nc bnc" id="L473" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L474">            getLog().info(&quot;Saving parts...&quot;);</span>
        }

<span class="nc" id="L477">        final DestinationFileCreator fileCreator = new DestinationFileCreator(sourceDirectory, outputDirectory);</span>
<span class="nc" id="L478">        fileCreator.setFileNamePattern(outputFileNamePattern);</span>
<span class="nc" id="L479">        final File file = fileCreator.create(source);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">        if (parts.size() == 1) {</span>
<span class="nc" id="L481">            saveCss(file, parts.get(0).toString());</span>
<span class="nc" id="L482">            return;</span>
        }

        // TODO add maxImports per file
<span class="nc" id="L486">        final StringBuilder imports = new StringBuilder();</span>
<span class="nc" id="L487">        final String cacheToken = createCacheToken();</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">        for (int index = 0; index &lt; parts.size(); ++index) {</span>
<span class="nc" id="L489">            final String filePartFormat = outputPartNamePattern.replace(PART_INDEX_PARAMETER, String.valueOf(index + 1));</span>
<span class="nc" id="L490">            fileCreator.setFileNamePattern(filePartFormat);</span>
<span class="nc" id="L491">            final File filePart = fileCreator.create(source);</span>
<span class="nc" id="L492">            imports.append(&quot;@import \&quot;&quot;);</span>
<span class="nc" id="L493">            imports.append(filePart.getName());</span>
<span class="nc" id="L494">            imports.append(cacheToken);</span>
<span class="nc" id="L495">            imports.append(&quot;\&quot;;\n&quot;);</span>
<span class="nc" id="L496">            saveCss(filePart, parts.get(index).toString());</span>
        }
<span class="nc" id="L498">        saveCss(file, imports.toString());</span>
<span class="nc" id="L499">    }</span>

    private String createCacheToken() {
<span class="nc bnc" id="L502" title="All 2 branches missed.">        if (TokenType.NONE.name().equalsIgnoreCase(cacheTokenType)) {</span>
<span class="nc" id="L503">            return &quot;&quot;;</span>
        } else {
<span class="nc" id="L505">            final String value = TokenType.create(cacheTokenType).createFactory().create(cacheTokenValue);</span>
<span class="nc" id="L506">            final StringBuilder cacheToken = new StringBuilder();</span>
<span class="nc" id="L507">            cacheToken.append('?');</span>
<span class="nc" id="L508">            cacheToken.append(UrlEscaper.escape(cacheTokenParameter));</span>
<span class="nc" id="L509">            cacheToken.append('=');</span>
<span class="nc" id="L510">            cacheToken.append(UrlEscaper.escape(value));</span>
<span class="nc" id="L511">            return cacheToken.toString();</span>
        }
    }

    private void saveCss(final File file, final String css) throws MojoFailureException {
<span class="nc bnc" id="L516" title="All 2 branches missed.">        if (verbose) {</span>
<span class="nc" id="L517">            getLog().info(&quot;Saving CSS code to &quot; + file.getAbsolutePath());</span>
        }
        try {
<span class="nc" id="L520">            FileUtils.write(file, css, encoding);</span>
<span class="nc" id="L521">        } catch (final IOException e) {</span>
<span class="nc" id="L522">            throw new MojoFailureException(&quot;Cannot save file: &quot; + file.getAbsolutePath(), e);</span>
<span class="nc" id="L523">        }</span>
<span class="nc" id="L524">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.6.201602180812</span></div></body></html>